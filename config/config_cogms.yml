credentials_file: ~/.uwo_credentials.bd
final_bids_dir: "/nfs/scratch/aakbar9/cfmm2bids/bids"

# 1. query
search_specs:
  - dicom_query:
      study_description: Menon^CogMS
#      study_date: 20230101-20230301
    metadata_mappings:
      subject:
        source: PatientID
        pattern: '[sS][fF][cC][-_]?([0-9]+)'
        sanitize: true
        premap:
          17.08.03-14:36:43-DST-1.3.12.2.1107.5.2.34.18932: SFC-103
          17.09.01-10:37:58-DST-1.3.12.2.1107.5.2.34.18932: SFC-105
          17.08.24-15:18:42-DST-1.3.12.2.1107.5.2.34.18932: SFC-104
          18.01.02-10:54:09-STD-1.3.12.2.1107.5.2.34.18932: SFC-115
          17.10.05-13:00:40-DST-1.3.12.2.1107.5.2.34.18932: SFC-106
          17.10.06-13:06:15-DST-1.3.12.2.1107.5.2.34.18932: SFC-301
          17.10.26-13:32:23-DST-1.3.12.2.1107.5.2.34.18932: SFC-107
          17.11.29-11:55:37-STD-1.3.12.2.1107.5.2.34.18932: SFC-113
          17.07.28-10:57:25-DST-1.3.12.2.1107.5.2.34.18932: SFC-101
          17.07.31-15:05:39-DST-1.3.12.2.1107.5.2.34.18932: SFC-102
          17.11.06-08:26:40-STD-1.3.12.2.1107.5.2.34.18932: SFC-303
          19.01.14-12:25:20-STD-1.3.12.2.1107.5.2.34.18932: SFC-110



      session:
        source: StudyDate
#        source: PatientID
#        pattern: '[sS][fF][cC][-_]?[0-9]+[-_](.+)$'
        sanitize: true
        # fillna: '01'
        # map:
        #  v2: '02'
        #  V2: '02'
        #
        #


# 2. filter
study_filter_specs:
  include:
  exclude:
#    - PatientID == '23.05.26-10:43:49-DST-1.3.12.2.1107.5.2.0.18932'
    - PatientID == 'TriggerTest'
    - subject != subject # if subject is nan 
    - StudyInstanceUID == '1.3.12.2.1107.5.2.34.18932.30000018071014504151500000004' #physio log only

  # Optional: Remap sessions based on study date ordering
  # Uncomment and configure to use time-based session labels
  remap_sessions_by_date:
    enable: true
    units: 'months'
    round_step: 6
    # Default behavior: Time since first session (baseline mode)
    # Sessions labeled as '0m', '6m', '12m', etc.
    
    # Zero-pad session labels (optional, default: false)
    # Set to true to ensure proper alphanumeric sorting of sessions
    # Example: '00m', '06m', '12m' instead of '0m', '6m', '12m'
    # zero_pad: false
    
    # Alternative: Calculate age at scan using birth date
    # Uncomment the following lines to use PatientBirthDate as reference:
    # reference_col: 'PatientBirthDate'
    # reference_format: '%Y%m%d'
    
    # Custom label mapping (optional)
    # If you prefer custom labels like 'baseline' instead of '0m':
    time_to_label:
      0: 'baseline'
  exclude_post_remap:
    - subject == '103' and session =='6m' #no dicoms error
    - subject == '104' and session =='baseline' #no dicoms error

       

# 3. download
cfmm2tar_download_options: ''
merge_duplicate_studies: True


# 4. convert
heudiconv_options: '--minmeta '
heuristic: heuristics/Menon_CogMSv2.py
dcmconfig_json: resources/dcm2niix_config.json
base_heuristics:
  - heuristics/cfmm_base.py

# 5. fix 
post_convert_fixes:
  - name: remove_rois
    pattern: "anat/*ROI1.*"
    action: remove

  - name: remove_scans_tsv
    pattern: "*scans.tsv"
    action: remove

  - name: sa2rage_metadata
    pattern: "fmap/*TB1SRGE.json"
    action: update_json
    updates:
      NumberShots: 1
      RepetitionTimeExcitation: 0.002
      RepetitionTimePreparation: 2.4

  - name: mp2rage_metadata
    pattern: "anat/*inv-*MP2RAGE.json"
    action: update_json
    updates:
      NumberShots: 1  # Single-shot
      RepetitionTimeExcitation: 0.0079 # Echo spacing from the protocol pdf
      RepetitionTimePreparation: 6 

  - name: phase_units
    pattern: "*/*part-phase*.json"
    action: update_json
    updates:
      Units: rad

  - name: phase_units_
    pattern: "*/*phase.json"
    action: update_json
    updates:
      Units: rad

  - name: remove_dupe_t1maps
    pattern: "*/*run-*_*T1map.nii.gz"
    action: remove_duplicate_niftis

  - name: remove_dupe_t1w
    pattern: "*/*run-*_*T1w.nii.gz"
    action: remove_duplicate_niftis

  - name: remove_dupe_mp2rage
    pattern: "*/*run-*_*MP2RAGE.nii.gz"
    action: remove_duplicate_niftis


bidsignore:
  - '*_acq-b1Div_*'
  - '*_b1DivImg.*'
  - '*_TB1Map.*'
  - '*echo*T1map.*'


# intermediate output folders
stages:
  query: "results/0_query"
  filter: "results/1_filter"
  download: "/nfs/scratch/akhan488/cogms-cfmm2bids/results/2_download"
  convert: "/nfs/scratch/aakbar9/cfmm2bids/results/3_convert"
  fix: "/nfs/scratch/aakbar9/cfmm2bids/results/4_fix"
